---
config:
  layout: fixed
---
flowchart LR
 subgraph U["Usuario (Emisor)"]
        A1["Create Campaign
- nombre, control_code, fechas
- responsable + backup
- reminders/escalado
- plantilla correo"]
        A3["Define Requests
Modo A: destinatario -> evidencias
Modo B: evidencias -> destinatarios
+ evidencias custom"]
        A5["Review & Adjust
- evidencias por request
- deadline / CC / delegado"]
        B15["Review Submissions
Abrir request en app"]
        B16["Validate / Reject
Rechazar requiere motivo"]
        C2["Close Request
Confirmar cierre"]
        C7["Campaign Dashboard
KPIs + Export report"]
  end
 subgraph APP["Internal App (Servidor)"]
        A2["Save Campaign
Generate campaign_id
Status = Draft"]
        A4["Generate Request Drafts
- request_id
- evidence_items
- deadline
- destinatario / CC / delegado"]
        A6["Confirm & Publish
- lock requests
- generate signed token links
Status = Ready to send"]
        D_A{"Send confirmed?"}
        D_B1{"Token valid?"}
        B3p["Show Submit Page"]
        OTP1["Request OTP (optional)"]
        D_B2{"OTP valid?"}
        B7["Save Submission
Update states
Evidence: Pending -> Submitted
Request: Sent/InProgress -> Submitted/Partial"]
        B17["Generate Subsanacion Draft
Only pendientes/rechazados"]
        D_B3{"All mandatory validated?"}
        C1["Status = Ready-to-close"]
        C3["Freeze & Generate Audit Report
Timeline + evidences + decisions"]
        B24["Update Reminder Count
last_reminder_at
AuditLog: Reminder sent"]
        LOG[("AuditLog
Immutable events")]
  end
 subgraph PA["Power Automate (Flows)"]
        F1["Flow 1: Send Initial Requests
HTTP Trigger"]
        B2["Send Emails (Outlook)
Subject: [control_code] + request_id
Body: list + deadline + link"]
        F2["Flow 2: Archive Evidence Files
HTTP Trigger"]
        B9["Create Folder / Create File
SharePoint connector"]
        N1["Notify Issuer
New submission to review"]
        F3["Flow 3: Reminder & Escalation
Scheduled daily"]
        B22["Filter requests needing reminder
status + dates + count"]
        D_B4{"Escalation level?"}
        B23["Send Reminder Email (Outlook)
keep request_id"]
        F4["Flow 4: Close + Archive Report
HTTP Trigger"]
        C5["Archive Report to SharePoint
+ optional close email"]
        OTP2["Send OTP Email (optional)"]
        F1b["Send Subsanacion Email
via Outlook"]
  end
 subgraph SP["SharePoint / Storage"]
        B10[("Evidences Library
/control_code/campaign_id/
request_id_destinatario/
Evidence_xxx/")]
        C6[("Reports
/control_code/campaign_id/
Campaign_Report.pdf
Request_Report.pdf")]
  end
    A1 --> A2
    A2 --> A3
    A3 --> A4
    A4 --> A5
    A5 --> A6
    A6 --> D_A
    D_A -- No --> A5
    D_A -- Yes --> F1
    F1 --> B2
    B2 --> D_B1
    D_B1 -- No --> X1["Link invalid/expired
Ask issuer for new link"]
    D_B1 -- Yes --> B3p
    B3p --> OTP1
    OTP1 -.-> OTP2
    OTP2 -.-> D_B2
    D_B2 -- No --> X2["OTP failed
Retry / lockout"]
    D_B2 -- Yes --> B6["Upload / Fill per Evidence Item
partial submissions allowed"]
    B6 --> B7
    B7 --> LOG & F2
    F2 --> B9 & N1
    B9 --> B10 & LOG
    N1 --> B15
    B15 --> B16
    B16 --> LOG & D_B3
    D_B3 -- No --> B17
    B17 --> F1b
    F1b --> B2 & LOG
    D_B3 -- Yes --> C1
    C1 --> C2
    C2 --> C3
    C3 --> LOG & F4
    F3 --> B22
    B22 --> D_B4
    D_B4 -- 1st reminder --> B23
    B23 --> B24
    B24 --> LOG
    D_B4 -- 2nd reminder (cc delegado) --> B23
    D_B4 -- 3rd reminder (cc socio/escalado) --> B23
    F4 --> C5
    C5 --> C6 & LOG
    C6 --> C7